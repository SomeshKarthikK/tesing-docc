
name: Create Release
on:
  push: 
    tags:
       - '[0-9]+.[0-9]+.[0-9]+'
       - '[0-9]+.[0-9]+.[0-9]+rc[0-9]+'
  workflow_dispatch:
    inputs:
      tag:
        type: string
        description: Version
        required: true
jobs:
  create_xcframework:
    name: Create XCFramework
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Create XCFramework
        id: framework_builder
        run: |
          path_from_script="bin/mktmp.txt"
          
          # if dir already exits delete it before proceed
          rm -rf "bin"
          
          #create the dir, since we are deleting it in the previous step
          mkdir "bin"
          
          touch $path_from_script
          
          ./Scripts/create-xcframework.sh 'SlothCreator' $path_from_script
          
          path_to_xcframework=`cat $path_from_script`
          file_name=`basename $path_to_xcframework`
          
          rm -f $path_from_script
          
          echo ::set-output name=path_to_xcframework::$path_to_xcframework
          echo ::set-output name=file_name::$file_name
      - uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.framework_builder.outputs.file_name }}
          path: ${{ steps.framework_builder.outputs.path_to_xcframework }}

  create_release:  
    name: Create Release and Upload artfifacts
    needs: create_xcframework
    runs-on: macos-latest
    steps:
      #1
      - uses: actions/checkout@v3
      #2
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.tag }} || ${{ github.ref }}
          release_name: ${{ github.ref }}
          body_path: ./release_notes.md
          draft: false
          prerelease: false
      # 3.
      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: SlothCreator.xcframework.zip
          path: ./
        # 5.
      - name: Upload Release Asset
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./SlothCreator.xcframework.zip
          asset_name: SlothCreator.xcframework.zip
          asset_content_type: application/zip

  cocoapods:
    name: Deploy to Cocoapods
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Deploy to Cocoapods
      run: |
        set -eo pipefail
        export LIB_VERSION=${{ inputs.tag }} || $(git describe --tags `git rev-list --tags --max-count=1`)
        pod lib lint --allow-warnings
        pod trunk push --allow-warnings
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      
